<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predição 2 - Nível de Risco</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <link rel="stylesheet" href="./css/p2.css" />
    
    
</head>

<body>

    <div>
        <div class="card-container">
            <label for="riscoSelect" class="risk-select-label">Nível de risco:</label>
            <select id="riscoSelect" class="risk-select"></select>
        </div>

        <div class="card-container">
            <h3 class="card-title">Top 3 servidores mais críticos:</h3>

            <!-- Aqui serão as cards dos 3 mais críticos -->
            <div id="resultado" class="server-grid"></div>
        </div>
    </div>

        <div class="card-container">
            <h3>Gráfico do servidor selecionado:</h3>
            <canvas id="grafico" height="120"></canvas>
        </div>

    <script>
        function toggleSelection(element) {
            document.querySelectorAll('.server-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
        }
    </script>

<script>
  const servidores = [
    { nome: "Servidor A", riscoConfig: 70, ultimos4: [40, 50, 55, 60] },
    { nome: "Servidor B", riscoConfig: 80, ultimos4: [65, 70, 72, 75] },
    { nome: "Servidor C", riscoConfig: 75, ultimos4: [50, 55, 60, 65] },
    { nome: "Servidor D", riscoConfig: 85, ultimos4: [75, 78, 82, 88] },
    { nome: "Servidor E", riscoConfig: 70, ultimos4: [30, 38, 44, 50] },
    { nome: "Servidor C", riscoConfig: 75, ultimos4: [50, 55, 60, 65] },
    { nome: "Servidor D", riscoConfig: 85, ultimos4: [75, 78, 82, 88] },
    { nome: "Servidor E", riscoConfig: 70, ultimos4: [30, 38, 44, 50] }
  ];

  const desvio = 5;

  function regressaoLinear(valores) {
    const n = valores.length;
    const xs = valores.map((_, i) => i);

    const somaX = xs.reduce((a, b) => a + b, 0);
    const somaY = valores.reduce((a, b) => a + b, 0);
    const somaXY = xs.reduce((acc, x, i) => acc + x * valores[i], 0);
    const somaX2 = xs.reduce((acc, x) => acc + x * x, 0);

    const m = (n * somaXY - somaX * somaY) / (n * somaX2 - somaX * somaX);
    const b = (somaY - m * somaX) / n;

    return { m, b };
  }

  function preverProximos(reg, quantidade, base) {
    const inicio = base.length;
    return Array.from({ length: quantidade }, (_, i) => reg.m * (inicio + i) + reg.b);
  }

  function filtrarServidores() {
    const risco = Number(document.getElementById("riscoSelect").value);
    const div = document.getElementById("resultado");

    if (!risco) {
      div.innerHTML = "<p class='no-results'>Selecione um nível de risco.</p>";
      return;
    }

    // Servidores que estão em risco
    const lista = servidores
      .filter(s => s.riscoConfig === risco)
      .slice(0, 3)
      .map(s => {
        const reg = regressaoLinear(s.ultimos4);
        const pred = preverProximos(reg, 3, s.ultimos4);

        return {
          nome: s.nome,
          riscoConfig: s.riscoConfig,
          ultimos4: s.ultimos4,
          predicoes: pred
        };
      });

    renderizar(lista);
  }

  function renderizar(lista) {
    const div = document.getElementById("resultado");
    div.innerHTML = "";

    if (lista.length == 0) {
      div.innerHTML = "<p class='no-results'>Nenhum servidor possui esse nível configurado.</p>";
      return;
    }

    lista.forEach(s => {
      const card = document.createElement("div");
      card.className = "server-card";
      card.setAttribute("onclick", "toggleSelection(this)");
      card.innerHTML = `
    <h4>${s.nome}</h4>
    <p>Risco configurado: <span class="risk-percentage">${s.riscoConfig}%</span></p>

    <button class="server-card-button"
        onclick='mostrarGrafico(${JSON.stringify(JSON.stringify(s))})'>
        Ver gráfico
    </button>
`;
      div.appendChild(card);
    });
  }

  let grafico;

function mostrarGrafico(jsonData) {
    const s = JSON.parse(jsonData);

    const labels = ["M-3", "M-2", "M-1", "M-0", "M+1", "M+2", "M+3"];
    const valores = [...s.ultimos4, ...s.predicoes];

    // Desvio padrão
    const desvioPositivo = [];
    const desvioNegativo = [];

    for (let i = 0; i < valores.length; i++) {
        if (i >= 3 && valores[i] != null) {
            desvioPositivo.push(valores[i] + desvio);
            desvioNegativo.push(valores[i] - desvio);
        } else {
            desvioPositivo.push(null);
            desvioNegativo.push(null);
        }
    }

    if (grafico){
        grafico.destroy();
    };

    const ctx = document.getElementById("grafico");

grafico = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [
                {
                    label: s.nome + " - Valores reais",
                    data: [...s.ultimos4, null, null, null],
                    borderColor: "#28a745",
                    borderWidth: 3,
                    fill: false
                },
                {
                    label: s.nome + " - Predição",
                    data: [null, null, null, s.ultimos4[3], ...s.predicoes],
                    borderColor: "#6990A7",
                    borderDash: [5, 5],
                    borderWidth: 3,
                    fill: false
                },
                {
                    label: "desvio +",
                    data: desvioPositivo,
                    borderColor: "rgba(0, 200, 0, 0.4)",
                    backgroundColor: "rgba(0,200,0,0.15)",
                    fill: "+1",
                    borderWidth: 2,
                    tension: 0
                },
                {
                    label: "desvio -",
                    data: desvioNegativo,
                    borderColor: "rgba(0, 200, 0, 0.4)",
                    backgroundColor: "rgba(0,200,0,0.15)",
                    fill: false,
                    borderWidth: 2,
                    tension: 0
                }
            ]
        },
        options: {
        responsive: true,
        plugins: {
            legend: {
            display: true,
            labels: {
                font: {
                size: 16   // aumenta fonte da legenda
                }
            }
            },
            annotation: {
            annotations: {
                linhaVertical: {
                type: 'line',
                xMin: 3,
                xMax: 3,
                borderColor: '#585555',
                borderWidth: 2,
                borderDash: [4, 3]
                },
                linhaHorizontal: {
                type: 'line',
                yMin: 80,
                yMax: 80,
                borderColor: '#ff0000',
                borderWidth: 2,
                },
            }
            }
        },
        scales: {
            x: {
            ticks: {
                font: {
                size: 14
                }
            },
            title: {
                display: true,
                text: "Meses",
                font: {
                size: 18
                }
            }
            },
            y: {
            ticks: {
                font: {
                size: 14
                }
            },
            title: {
                display: true,
                text: "Quantidade de disco usado (em Gb)",
                font: {
                size: 18
                }
            }
            }
        }
        }
    });
}

  // montar select
  function montarSelect() {
    const select = document.getElementById("riscoSelect");
    for (let i = 70; i <= 100; i += 5) {
      const op = document.createElement("option");
      op.value = i;
      op.textContent = i + "%";
      select.appendChild(op);
    }
  }

  montarSelect();
  document.getElementById("riscoSelect").addEventListener("change", filtrarServidores);


</script>

</body>
</html>
