<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IntelVision | Servidores</title>
    <link rel="stylesheet" href="./css/global.css" />
    <link rel="stylesheet" href="./css/dashboard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.1"></script>
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
    <script src="./js/sessao.js"></script>
    <script src="./js/alerta.js"></script>
</head>

<body onload="
  validarSessaoAdministrador(), puxarDadosServidor(), dataAtual()
  ">
    <header>
        <div class="cabecalho-dash">
            <div class="nome-dash">
                <i class="fa-solid fa-chart-simple"></i>
                <h3>Dashboard</h3>
            </div>

            <div class="icone-usuario">
                <i class="fa-solid fa-user"></i>
                <img src="../public/assets/cadastro/iconeUser.jpg" alt="" />
            </div>
        </div>
    </header>

    <div class="janela">
        <!-- MENU -->
        <div class="header-left">
            <h1>IntelVision</h1>
            <div class="escolhaDash">
                <a href="servidores.html">
                    <div class="btn-nav inativo">
                        <span>
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#8b979f">
                                <path
                                    d="M520-600v-240h320v240H520ZM120-440v-400h320v400H120Zm400 320v-400h320v400H520Zm-400 0v-240h320v240H120Zm80-400h160v-240H200v240Zm400 320h160v-240H600v240Zm0-480h160v-80H600v80ZM200-200h160v-80H200v80Zm160-320Zm240-160Zm0 240ZM360-280Z" />
                            </svg>
                            <h3>Dashboard</h3>
                        </span>
                    </div>
                </a>

                <a href="comparativo.html">
                    <div class="btn-nav inativo">
                        <span>
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                background="#FFFFFF" fill="#8b979f">
                                <path
                                    d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480v-80H240v80Zm0-160h480v-80H240v80Zm0-160h480v-80H240v80ZM200-200v-560 560Z" />
                            </svg>
                            <h3>Comparativo</h3>
                        </span>
                    </div>
                </a>

                <a href="predicao.html">
                    <div class="btn-nav inativo">
                        <span>
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#8b979f">
                                <path
                                    d="M480-120 232-360l-112 80v-98l120-86 245 238 167-134h188v80H680L480-120Zm0-360L305-655 120-520v-99l193-141 175 175 352-255v99L480-480Z" />
                            </svg>
                            <h3>Predição</h3>
                        </span>
                    </div>
                </a>

                <a href="trafego.html">
                    <div class="btn-nav inativo">
                        <span>
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#8b979f">
                                <path
                                    d="M198-278q-57-57-87.5-129.5T80-560q0-80 30.5-152.5T198-842l48 48q-47 47-72.5 107.5T148-560q0 66 25.5 126.5T246-326l-48 48Zm92-92q-38-38-58-87t-20-103q0-54 20-103t58-87l48 48q-29 29-43.5 65.5T280-560q0 40 14.5 76.5T338-418l-48 48Zm150 250v-348q-27-12-43.5-37T380-560q0-42 29-71t71-29q42 0 71 29t29 71q0 30-16.5 55T520-468v348h-80Zm230-250-48-48q29-29 43.5-65.5T680-560q0-40-14.5-76.5T622-702l48-48q38 38 58 87t20 103q0 54-20 103t-58 87Zm92 92-48-48q47-47 72.5-107.5T812-560q0-66-25.5-126.5T714-794l48-48q57 57 87.5 129.5T880-560q0 80-30.5 152.5T762-278Z" />
                            </svg>
                            <h3>Tráfego de rede</h3>
                        </span>
                    </div>
                </a>

                <a href="./tela-servidores-codecs.html">
                    <div class="btn-nav inativo" id="btn-nav-admin-servidores">
                        <span>
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                                fill="#8b979f">
                                <path
                                    d="M160-400v-80h640v80H160Zm0-120v-80h640v80H160ZM440-80v-128l-64 64-56-56 160-160 160 160-56 56-64-62v126h-80Zm40-560L320-800l56-56 64 64v-128h80v128l64-64 56 56-160 160Z" />
                            </svg>
                            <h3>Análise-Codecs</h3>
                        </span>
                    </div>
                </a>
            </div>

            <a href="./dashboard-jira.html">
                <div class="btn-nav ativo">
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="#8b979f">
                            <path
                                d="M160-160v-440h160v440H160Zm0-480v-160h160v160H160Zm240 480v-320h160v320H400Zm0-360v-160h160v160H400Zm240 360v-200h160v200H640Zm0-240v-160h160v160H640Z" />
                        </svg>
                        <h3>Chamados</h3>
                    </span>
                </div>
            </a>

            <a href="./tela-administracao-usuario.html">
                <div class="btn-nav inativo" id="btn-nav-admin-usuarios">
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="#8b979f">
                            <path
                                d="M400-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM80-160v-112q0-33 17-62t47-44q51-26 115-44t141-18h14q6 0 12 2-8 18-13.5 37.5T404-360h-4q-71 0-127.5 18T180-306q-9 5-14.5 14t-5.5 20v32h252q6 21 16 41.5t22 38.5H80Zm560 40-12-60q-12-5-22.5-10.5T584-204l-58 18-40-68 46-40q-2-14-2-26t2-26l-46-40 40-68 58 18q11-8 21.5-13.5T628-460l12-60h80l12 60q12 5 22.5 11t21.5 15l58-20 40 70-46 40q2 12 2 25t-2 25l46 40-40 68-58-18q-11 8-21.5 13.5T732-180l-12 60h-80Zm40-120q33 0 56.5-23.5T760-320q0-33-23.5-56.5T680-400q-33 0-56.5 23.5T600-320q0 33 23.5 56.5T680-240ZM400-560q33 0 56.5-23.5T480-640q0-33-23.5-56.5T400-720q-33 0-56.5 23.5T320-640q0 33 23.5 56.5T400-560Zm0-80Zm12 400Z" />
                        </svg>
                        <h3>Adm - Usuários</h3>
                    </span>
                </div>
            </a>

            <a href="./tela-administracao-servidores.html">
                <div class="btn-nav inativo" id="btn-nav-admin-servidores">
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="#8b979f">
                            <path
                                d="M200-200v-160 4-4 160Zm0 80q-33 0-56.5-23.5T120-200v-160q0-33 23.5-56.5T200-440h560q33 0 56.5 23.5T840-360H200v160h400v80H200Zm0-400q-33 0-56.5-23.5T120-600v-160q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v160q0 33-23.5 56.5T760-520H200Zm0-80h560v-160H200v160Zm0 0v-160 160ZM760-40v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80Z" />
                        </svg>
                        <h3>Adm - Servidores</h3>
                    </span>
                </div>
            </a>

            <div class="btn-nav btn-logout inativo" onclick="limparSessao()">
                <a href="./index.html">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#8b979f">
                        <path
                            d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z" />
                    </svg>
                    <h3>Sair</h3>
                </a>
            </div>
        </div>
        <!-- FIM MENU -->
    </div>

    <!-- Conteúdo da página -->
    <div class="dash">
        <div class="dash__conteudo">

            <div class="div_dashboard_kpis_jira">
                <div class="ipt_procura bloco_kpi_jira" style="border: 3px solid #3e65ff;">
                    <div class="titulo_kpi_jira" style="background: #a1b4ff;">
                        <h3>Chamados em Abaixo</h3>
                    </div>
                    <p id="kpi_chamados_abaixo">0</p>
                </div>
                <div class="ipt_procura bloco_kpi_jira" style="border: 3px solid #ffb855;">
                    <div class="titulo_kpi_jira" style="background: #ffd78c;">
                        <h3>Chamados em Alerta</h3>
                    </div>
                    <p id="kpi_chamados_alerta">0</p>
                </div>
                <div class="ipt_procura bloco_kpi_jira" style="border: 3px solid #ff4d4d;">
                    <div class="titulo_kpi_jira" style="background: #ff8383;">
                        <h3>Chamados em Crítico</h3>
                    </div>
                    <p id="kpi_chamados_critico">0</p>
                </div>
            </div>

            <!-- Filtro Servidores -->
            <div class="kpi-container div-procura div_container_jira">

                <div class="filtro_servidores div-ipt-procura">
                    <p>Filtrar Tipo dos Servidores:</p>
                    <select name="fitro_tipo_servidor" id="filtro_tipo_servidor" class="ipt_procura">
                        <option value="Todos">Todos</option>
                        <option value="Armazenamento">Armazenamento</option>
                        <option value="Processamento">Processamento</option>
                        <option value="Web">WEB</option>
                    </select>
                </div>
                <div class="filtro_servidores div-ipt-procura">
                    <p>Filtrar Situação dos Chamados:</p>
                    <select name="fitro_tipo_servidor" id="filtro_situacao_chamado" class="ipt_procura">
                        <option value="Todos">Todos</option>
                        <option value="Aberto">Abertos</option>
                        <option value="Fechado">Fechados</option>
                    </select>
                </div>
                <div class="filtro_servidores div-ipt-procura">
                    <p>Filtrar Situação dos Servidores:</p>
                    <select name="fitro_situacao_servidor" id="filtro_situacao_servidor" class="ipt_procura">
                        <option value="Todos">Todos</option>
                        <option value="ABAIXO">Abaixo</option>
                        <option value="ALERTA">Alerta</option>
                        <option value="CRITICO">Crítico</option>
                    </select>
                </div>
                <div class="div-links-contas filtro_servidores">
                    <a onclick="atualizarDados()" class="X">
                        <!-- <div class="div-botao"> -->
                        <h3>Atualizar</h3>
                        <!-- </div> -->
                    </a>
                </div>
            </div>


            <div style="display: flex;">
                <!-- Gráfico -->
                <div class="chart-container" style="flex:2">
                    <div>
                        <label for="">Início: </label>
                        <input type="date" onchange="atualizarDados()" id="dataInicio">
                        <label for="">Fim: </label>
                        <input type="date" onchange="atualizarDados()" id="dataFim">
                    </div>
                    <h3>Quantidade de Chamados abertos</h3>
                    <canvas id="requisicoesDia"></canvas>
                </div>

                <!-- Rosca -->
                <div class="grafico_rosca_mttr">
                    <h2>Tempo Médio de Resolução</h2>
                    <div class="mttr">
                        <img src="../assets/img/rosca-verde.png" width="100%">
                        <h1 style="position: absolute;" id="valor_mttr">3d12h</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>

    <script>
        let datasLabel = []
        let datasContagemWeb = [];
        let datasContagemProc = [];
        let datasContagemArm = [];


        // Gráfico de Requisições por dia
        const ctxDia = document.getElementById("requisicoesDia");
        const chart = new Chart(ctxDia, {
            type: "bar",
            data: {
                labels: datasLabel,
                datasets: [
                    {
                        label: "Web",
                        data: datasContagemWeb,
                        backgroundColor: "orange",
                        stack: "Stack 1"
                    },
                    {
                        label: "Processamento",
                        data: datasContagemProc,
                        backgroundColor: "darkseagreen",
                        stack: "Stack 1"
                    },
                    {
                        label: "Armazenamento",
                        data: datasContagemArm,
                        backgroundColor: "darkgoldenrod",
                        stack: "Stack 1"
                    },
                ],
            },
            options: { responsive: true, plugins: { legend: { display: true } } },
        });

        let csv;
        let chamadosFiltrados = [];
        let contAbaixoKPI = 0;
        let contAlertaKPI = 0;
        let contCriticoKPI = 0;


        async function carregarCSV() {
            // DADOS ATRAVÉS DO CHAMADOS.CSV NO PROJETO
            // const response = await fetch("./dados_csv/chamados.csv");
            // const text = await response.text();

            // DADOS ATRAVÉS DO BUCKET S3
            const response = await fetch("/dados/chamados");
            const dataUrl = await response.json();
            const download = await fetch(dataUrl.url);
            const text = await download.text();

            const lines = text.split("\n").map(l => l.trim());
            const header = lines[0].split(";");

            csv = lines.slice(1).map(line => {
                const values = line.split(";");
                const obj = {};

                header.forEach((key, index) => {
                    const cleanedValue = values[index]?.replace(/^"|"$/g, "") || "";
                    obj[key] = cleanedValue;

                    obj["Criado"] = new Date(obj["Criado"]);
                });

                return obj;
            });
            atualizarDados();
        }

        carregarCSV();

        function atualizarDados() {
            let tipoSelecionado = document.getElementById("filtro_tipo_servidor").value;
            let situacaoChamado = document.getElementById("filtro_situacao_chamado").value;
            let situacaoServidor = document.getElementById("filtro_situacao_servidor").value;

            let dataInicio = new Date(document.getElementById("dataInicio").value);
            let dataFim = new Date(document.getElementById("dataFim").value);

            dataInicio.setDate(dataInicio.getDate() + 1)
            dataInicio.setHours(0, 0, 0, 1);
            dataFim.setDate(dataFim.getDate() + 1)
            dataFim.setHours(23, 59, 59, 999);

            let datas = gerarDatasEntre(dataInicio, dataFim);

            contAbaixoKPI = 0;
            contAlertaKPI = 0;
            contCriticoKPI = 0;

            let contWeb = {};
            let contProc = {};
            let contArm = {};

            datas.forEach(d => {
                contWeb[d] = 0;
                contProc[d] = 0;
                contArm[d] = 0;
            });

            chamadosFiltrados = [];

            csv.forEach(item => {
                if (item["Criado"] >= dataInicio && item["Criado"] <= dataFim) {

                    let tipo = detectarTipo(item["Labels"]);

                    if (tipoSelecionado != "Todos" && tipo != tipoSelecionado)
                        return;

                    if (situacaoChamado === "Fechado" && item["Status"] !== "Concluído") {
                        return;
                    }

                    if (situacaoChamado === "Aberto" && item["Status"] === "Concluído") {
                        return;
                    };

                    let labels = parseLabels(item["Labels"]);

                    if (labels.includes("ABAIXO")) {
                        contAbaixoKPI++;
                    } else if (labels.includes("ALERTA")) {
                        contAlertaKPI++;
                    } else if (labels.includes("CRITICO")) {
                        contCriticoKPI++;
                    }

                    if (situacaoServidor !== "Todos") {
                        let filtroNormalizado = removerAcentos(situacaoServidor.toUpperCase());
                        if (!labels.includes(filtroNormalizado)) return;
                    }



                    let dataFormatada = formatarData(item["Criado"]);

                    if (tipo === "Web") {
                        contWeb[dataFormatada]++;
                    }
                    if (tipo === "Processamento") {
                        contProc[dataFormatada]++;
                    }
                    if (tipo === "Armazenamento") {
                        contArm[dataFormatada]++;
                    }

                    chamadosFiltrados.push(item);
                }
            });

            datasLabel = datas;
            datasContagemWeb = datas.map(d => contWeb[d]);
            datasContagemProc = datas.map(d => contProc[d]);
            datasContagemArm = datas.map(d => contArm[d]);

            atualizarGrafico();
        }



        function gerarDatasEntre(inicio, fim) {
            let data = new Date(inicio);
            let datas = [];

            while (data <= fim) {
                datas.push(formatarData(data));
                data.setDate(data.getDate() + 1);
            }

            return datas;
        }

        function formatarData(d) {
            let data = new Date(d);
            let dia = String(data.getDate()).padStart(2, "0");
            let mes = String(data.getMonth() + 1).padStart(2, "0");
            let ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        function atualizarGrafico() {
            chart.data.labels = datasLabel;
            chart.data.datasets[0].data = datasContagemWeb;
            chart.data.datasets[1].data = datasContagemProc;
            chart.data.datasets[2].data = datasContagemArm;
            chart.update();

            atualizarTempoMedioResolucao(chamadosFiltrados);
        }

        function detectarTipo(labelsString) {
            let labels = [];
            try {
                labels = JSON.parse(labelsString);
            } catch {
                return null;
            }

            if (labels.includes("HD")) return "Armazenamento";
            if (labels.includes("RAM")) return "Processamento";
            if (labels.includes("CPU")) return "Web";

            return null;
        }

        function parseLabels(labelsString) {
            try {
                let arr = JSON.parse(labelsString);
                return arr.map(l => removerAcentos(l.toUpperCase()));
            } catch {
                return [];
            }
        }

        function removerAcentos(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // Função MTTR

        function extrairDias(descricao) {
            if (!descricao) return null;
            const match = descricao.match(/^\d+/);
            return match ? parseInt(match[0], 10) : null;
        }

        function calcularMediaResolucaoFiltrada(chamadosFiltrados) {
            if (!chamadosFiltrados || chamadosFiltrados.length === 0) return 0;

            let soma = 0;
            let count = 0;

            chamadosFiltrados.forEach(item => {
                const dias = extrairDias(item["Descricao"]);
                if (dias !== null) {
                    soma += dias;
                    count++;
                }
            });

            return count > 0 ? (soma / count)/24 : 0;
        }


        function atualizarTempoMedioResolucao(chamadosFiltrados) {
            const media = calcularMediaResolucaoFiltrada(chamadosFiltrados);
            const dias = Math.floor(media);
            const horas = Math.floor((media - dias) * 24);
            const h1 = document.getElementById("valor_mttr");
            if(dias <= 0){
                h1.textContent = `${horas}h`;
            } else{
                h1.textContent = `${dias}d${horas}h`;
            }

            const kpiAbaixo = document.getElementById("kpi_chamados_abaixo");
            const kpiAlerta = document.getElementById("kpi_chamados_alerta");
            const kpiCritico = document.getElementById("kpi_chamados_critico");

            kpiAbaixo.textContent = `${contAbaixoKPI}`;
            kpiAlerta.textContent = `${contAlertaKPI}`;
            kpiCritico.textContent = `${contCriticoKPI}`;
        }

        function dataAtual() {
            let diaHoje = new Date();
            let dia7atras = new Date();
            dia7atras.setDate(dia7atras.getDate() - 7);

            const dataHoje = diaHoje.toISOString().split('T')[0];
            const data7diasAtras = dia7atras.toISOString().split('T')[0];

            dataInicio.value = data7diasAtras;
            dataFim.value = dataHoje;
        }

    </script>
    <script src="./js/situacaoServidores.js"></script>
</body>

</html>