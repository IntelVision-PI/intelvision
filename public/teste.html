<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IntelVision | Servidores</title>
  <link rel="stylesheet" href="./css/global.css" />
  <link rel="stylesheet" href="./css/dashboard.css" />
  <link rel="stylesheet" href="./css/predicoes.css" />
  <link rel="stylesheet" href="./css/p2.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.1"></script>
  <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessaoAdministrador()">
  <header>
    <div class="cabecalho-dash">
      <div class="nome-dash">
        <i class="fa-solid fa-magnifying-glass-chart"></i>
        <h3>Dashboard</h3>
      </div>

      <div class="icone-usuario">
        <i class="fa-solid fa-user"></i>
      </div>
    </div>
  </header>

  <div class="janela">
    <div class="header-left">
      <h1>IntelVision</h1>

      <div class="escolhaDash">
        <a href="./servidores.html">
          <div class="btn-nav ativo">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#8b979f">
                <path
                  d="M520-600v-240h320v240H520ZM120-440v-400h320v400H120Zm400 320v-400h320v400H520Zm-400 0v-240h320v240H120Zm80-400h160v-240H200v240Zm400 320h160v-240H600v240Zm0-480h160v-80H600v80ZM200-200h160v-80H200v80Zm160-320Zm240-160Zm0 240ZM360-280Z" />
              </svg>
              <h3>Dashboard</h3>
            </span>
          </div>
        </a>

        <a href="./tela-administracao-usuario.html">
          <div class="btn-nav inativo" id="btn-nav-admin-usuarios">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#8b979f">
                <path
                  d="M400-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM80-160v-112q0-33 17-62t47-44q51-26 115-44t141-18h14q6 0 12 2-8 18-13.5 37.5T404-360h-4q-71 0-127.5 18T180-306q-9 5-14.5 14t-5.5 20v32h252q6 21 16 41.5t22 38.5H80Zm560 40-12-60q-12-5-22.5-10.5T584-204l-58 18-40-68 46-40q-2-14-2-26t2-26l-46-40 40-68 58 18q11-8 21.5-13.5T628-460l12-60h80l12 60q12 5 22.5 11t21.5 15l58-20 40 70-46 40q2 12 2 25t-2 25l46 40-40 68-58-18q-11 8-21.5 13.5T732-180l-12 60h-80Zm40-120q33 0 56.5-23.5T760-320q0-33-23.5-56.5T680-400q-33 0-56.5 23.5T600-320q0 33 23.5 56.5T680-240ZM400-560q33 0 56.5-23.5T480-640q0-33-23.5-56.5T400-720q-33 0-56.5 23.5T320-640q0 33 23.5 56.5T400-560Zm0-80Zm12 400Z" />
              </svg>
              <h3>Adm - Usuários</h3>
            </span>
          </div>
        </a>

        <a href="./tela-administracao-servidores.html">
          <div class="btn-nav inativo" id="btn-nav-admin-servidores">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#8b979f">
                <path
                  d="M200-200v-160 4-4 160Zm0 80q-33 0-56.5-23.5T120-200v-160q0-33 23.5-56.5T200-440h560q33 0 56.5 23.5T840-360H200v160h400v80H200Zm0-400q-33 0-56.5-23.5T120-600v-160q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v160q0 33-23.5 56.5T760-520H200Zm0-80h560v-160H200v160Zm0 0v-160 160ZM760-40v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80Z" />
              </svg>
              <h3>Adm - Servidores</h3>
            </span>
          </div>
        </a>

        <a href="./tela-servidores-codecs.html">
          <div class="btn-nav inativo" id="btn-nav-admin-servidores">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#8b979f">
                <path
                  d="M160-400v-80h640v80H160Zm0-120v-80h640v80H160ZM440-80v-128l-64 64-56-56 160-160 160 160-56 56-64-62v126h-80Zm40-560L320-800l56-56 64 64v-128h80v128l64-64 56 56-160 160Z" />
              </svg>
              <h3>Análise-Codecs</h3>
            </span>
          </div>
        </a>
      </div>

      <div class="btn-nav btn-logout" onclick="limparSessao()">
        <a href="./index.html">
          <i class="fa-solid fa-right-from-bracket"></i>
          <h3>Sair</h3>
        </a>
      </div>
    </div>

    <!-- Conteúdo da página -->
    <div class="dash">
      <div class="dash__conteudo">
        <!-- <div class="div_cadastrar" id="statusReportModal">
          <div class="cadastro_wrapper">
            <div class="cabecalho_cadastro report-header">
              <h2 class="report-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="lucide lucide-file-text">
                  <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" />
                  <path d="M14 2v4a2 2 0 0 0 2 2h4" />
                  <line x1="16" x2="8" y1="13" y2="13" />
                  <line x1="16" x2="8" y1="17" y2="17" />
                  <line x1="10" x2="8" y1="9" y2="9" />
                </svg>
                Relatórios da Situação
              </h2>
              <span class="material-symbols-outlined X"
                onclick="document.getElementById('statusReportModal').style.display='none'"> X </span>
            </div>
            <div class="div-situacao-container report-body-grid">

              <div class="div-situacao coluna-de-risco">
                <div class="icon-container-risk">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="#fee2e2"
                    stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-alert-triangle drop-shadow-sm">
                    <path
                      d="m21.73 18.23-8.87-15.04a2 2 0 0 0-3.52 0l-8.87 15.04a2 2 0 0 0 1.76 2.77h17.74a2 2 0 0 0 1.76-2.77z" />
                    <path d="M12 9v4" />
                    <path d="M12 17h.01" />
                  </svg>
                  <h4 class="report-subtitle text-risk">Situação de risco</h4>
                </div>

                <div class="div-situacao-servidores negativo">sadasdasdasd</div>
                <div class="div">sadasdasdasd</div>

              </div>

              <div class="div-situacao coluna-positiva">
                <div class="icon-container-safe">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="#d1fae5"
                    stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-thumbs-up drop-shadow-sm">
                    <path d="M7 10v12h10l3.5-7L16 10h-6l2-7H4v7" />
                    <path d="M7 10v12" />
                  </svg>
                  <h4 class="report-subtitle text-safe">Situação fora de risco</h4>
                </div>

              </div>
            </div>
          </div>
        </div> -->
        <!-- KPI do relatório -->
        <div class="div-kpi-1">
          <div class="div-relatorio">
            <div class="div-kpi-predicao">
              <div class="div-textos-kpi">
                <span class="span-titulo-kpi">Servidores saudáveis</span>
                <span class="span-numero-kpi">04</span>
                <span class="span-sub-titulo-kpi">nos próximos 3 meses</span>
              </div>

              <div class="div-simbolo-kpi">
                <div class="div-bola-relatorio">
                  <span class="flat-color-icons--negative-dynamic"></span>
                </div>
              </div>
            </div>
            <div class="div-kpi-predicao">
              <div class="div-textos-kpi">
                <span class="span-titulo-kpi">Servidores em perigo</span>
                <span class="span-numero-kpi">10</span>
                <span class="span-sub-titulo-kpi">nos próximos 3 meses</span>
              </div>

              <div class="div-simbolo-kpi">
                <div class="div-bola-relatorio perigo">
                  <span class="flat-color-icons--positive-dynamic"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="div-relatorio">
            <div class="div-botao-relatorio">
              <div class="div-flex">
                <div class="div-textos">
                  <h2 class="h2-branco">Relatórios da situação</h2>
                  <p class="p-verde">Relatórios e análise para auxílio</p>
                </div>
                <div class="div-bola-relatorio">
                  <span class="mdi--file-report-outline"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Gráficos de requisições por hora -->
        <div class="grafico-predicao-container">
          <div class="card-container">
            <label for="riscoSelect" class="risk-select-label">Nível de risco:</label>
            <select id="riscoSelect" class="risk-select"></select>
          </div>

          <div class="card-container">
            <h3 class="card-title">Top 3 servidores mais críticos:</h3>

            <!-- Aqui serão as cards dos 3 mais críticos -->
            <div id="resultado" class="server-grid"></div>
          </div>
        </div>

        <div class="card-container">
          <h3>Gráfico do servidor selecionado:</h3>
          <canvas id="grafico" height="120"></canvas>
        </div>

        <div class="chart-container-teste">
          <h3>Comparação anual de disco</h3>
          <canvas id="discoAnual"></canvas>
        </div>
      </div>
    </div>
  </div>
</body>

</html>
<script>
  function toggleSelection(element) {
    document.querySelectorAll('.server-card').forEach(card => {
      card.classList.remove('selected');
    });
    element.classList.add('selected');
  }
</script>

<script src="js/predicao.js"></script>

<script type="module">

  if (!dados2025 || !Array.isArray(dados2025)) {
    console.error("ERRO: dados2025 não é um array válido:", dados2025);
    return;
}

// pegar o disco dos últimos registros
const valoresDisco = dados2025.map(item => Number(item.disco));

// garantir que existem pelo menos 4 registros
if (valoresDisco.length < 4) {
    console.error("ERRO: não há dados suficientes para regressão. Registros:", valoresDisco.length);
    return;
}

// últimos 4 valores
const ultimos4 = valoresDisco.slice(-4);

// rodar a regressão linear
const reg = regressaoLinear(ultimos4);


const desvio = 5;

// Regressão
function regressaoLinear(valores) {
  const n = valores.length;
  const xs = valores.map((_, i) => i);

  let somaX = 0, somaY = 0, somaXY = 0, somaX2 = 0;

  for (let i = 0; i < n; i++) {
    somaX += xs[i];
    somaY += valores[i];
    somaXY += xs[i] * valores[i];
    somaX2 += xs[i] * xs[i];
  }

  const m = (n * somaXY - somaX * somaY) / (n * somaX2 - somaX * somaX);
  const b = (somaY - m * somaX) / n;

  return { m, b };
}

function preverProximos(reg, quantidade, base) {
  const inicio = base.length;
  const result = [];

  for (let i = 0; i < quantidade; i++) {
    result.push(reg.m * (inicio + i) + reg.b);
  }
  return result;
}

// Predição
let grafico;

function mostrarGraficoPredicao() {
  if (!dados2025) return;

  const ultimos4 = dados2025.meses_anteriores;
  const reg = regressaoLinear(ultimos4);
  const predicoes = preverProximos(reg, 3, ultimos4);

  const labels = ["M-3", "M-2", "M-1", "M-0", "M+1", "M+2", "M+3"];
  const valores = [...ultimos4, ...predicoes];

  const desvioPositivo = [];
  const desvioNegativo = [];

  for (let i = 0; i < valores.length; i++) {
    if (i >= 3) {
      desvioPositivo[i] = valores[i] + desvio;
      desvioNegativo[i] = valores[i] - desvio;
    } else {
      desvioPositivo[i] = null;
      desvioNegativo[i] = null;
    }
  }

  if (grafico) grafico.destroy();

  const ctx = document.getElementById("grafico");

  grafico = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Valores reais",
          data: [...ultimos4, null, null, null],
          borderColor: "#28a745",
          borderWidth: 3,
          fill: false
        },
        {
          label: "Predição",
          data: [null, null, null, ultimos4[3], ...predicoes],
          borderColor: "#6990A7",
          borderDash: [5, 5],
          borderWidth: 3,
          fill: false
        },
        {
          label: "desvio +",
          data: desvioPositivo,
          borderColor: "rgba(0, 200, 0, 0.4)",
          backgroundColor: "rgba(0,200,0,0.15)",
          fill: "+1",
          borderWidth: 2,
          tension: 0
        },
        {
          label: "desvio -",
          data: desvioNegativo,
          borderColor: "rgba(0, 200, 0, 0, 0.4)",
          backgroundColor: "rgba(0,200,0,0.15)",
          fill: false,
          borderWidth: 2,
          tension: 0
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          labels: { font: { size: 16 } }
        },
        annotation: {
          annotations: {
            linhaVertical: {
              type: 'line',
              xMin: 3,
              xMax: 3,
              borderColor: '#585555',
              borderWidth: 2,
              borderDash: [4, 3]
            },
            linhaHorizontal: {
              type: 'line',
              yMin: 80,
              yMax: 80,
              borderColor: '#ff0000',
              borderWidth: 2
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { font: { size: 14 } },
          title: { display: true, text: "Meses", font: { size: 18 } }
        },
        y: {
          ticks: { font: { size: 14 } },
          title: { display: true, text: "Quantidade de disco usado (GB)", font: { size: 18 } }
        }
      }
    }
  });
}

// Grafico Anual
function criarGraficoAnual() {
  if (!dados2024 || !dados2025) return;

  const ctxCPU = document.getElementById("discoAnual");

  new Chart(ctxCPU, {
    type: "bar",
    data: {
      labels: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
      datasets: [
        {
          label: "Ano atual",
          data: dados2025.meses_ano_atual,
          backgroundColor: "#64748b",
          borderWidth: 2,
          borderRadius: {
            topLeft: 7, topRight: 7,
            bottomLeft: 0, bottomRight: 0
          }
        },
        {
          label: "Ano anterior",
          data: dados2024.meses_ano_anterior,
          backgroundColor: "#1e293b",
          borderWidth: 2,
          borderRadius: {
            topLeft: 7, topRight: 7,
            bottomLeft: 0, bottomRight: 0
          }
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: "%" }
        }
      }
    }
  });
}

// Após carregar tudo do S3 → mostrar gráficos
carregarArquivosS3().then(() => {
  mostrarGraficoPredicao();
  criarGraficoAnual();
});
</script>
