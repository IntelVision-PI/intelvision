<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IntelVision | Comparativo de Performance</title>

    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/comparativo.css" />

    <style>
        .kpi-subtext {
            font-size: 0.85rem;
            color: #666;
            margin-top: -5px;
            margin-bottom: 10px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 10px;
            display: inline-block;
        }

        .status-ok {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-alerta {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .status-critico {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessaoAdministrador()">

   <div class="header-left">
      <h1>IntelVision</h1>
      <div class="escolhaDash">
        <a href="servidores.html">
          <div class="btn-nav inativo">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#8b979f">
                <path
                  d="M520-600v-240h320v240H520ZM120-440v-400h320v400H120Zm400 320v-400h320v400H520Zm-400 0v-240h320v240H120Zm80-400h160v-240H200v240Zm400 320h160v-240H600v240Zm0-480h160v-80H600v80ZM200-200h160v-80H200v80Zm160-320Zm240-160Zm0 240ZM360-280Z" />
              </svg>
              <h3>Dashboard</h3>
            </span>
          </div>
        </a>

        <a href="comparativo.html">
          <div class="btn-nav ativo">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                background="#FFFFFF" fill="#8b979f">
                <path
                  d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480v-80H240v80Zm0-160h480v-80H240v80Zm0-160h480v-80H240v80ZM200-200v-560 560Z" />
              </svg>
              <h3>Comparativo</h3>
            </span>
          </div>
        </a>

        <a href="predicao.html">
          <div class="btn-nav inativo">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#8b979f">
                <path
                  d="M480-120 232-360l-112 80v-98l120-86 245 238 167-134h188v80H680L480-120Zm0-360L305-655 120-520v-99l193-141 175 175 352-255v99L480-480Z" />
              </svg>
              <h3>Predição</h3>
            </span>
          </div>
        </a>

        <a href="trafego.html">
          <div class="btn-nav inativo">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#8b979f">
                <path
                  d="M198-278q-57-57-87.5-129.5T80-560q0-80 30.5-152.5T198-842l48 48q-47 47-72.5 107.5T148-560q0 66 25.5 126.5T246-326l-48 48Zm92-92q-38-38-58-87t-20-103q0-54 20-103t58-87l48 48q-29 29-43.5 65.5T280-560q0 40 14.5 76.5T338-418l-48 48Zm150 250v-348q-27-12-43.5-37T380-560q0-42 29-71t71-29q42 0 71 29t29 71q0 30-16.5 55T520-468v348h-80Zm230-250-48-48q29-29 43.5-65.5T680-560q0-40-14.5-76.5T622-702l48-48q38 38 58 87t20 103q0 54-20 103t-58 87Zm92 92-48-48q47-47 72.5-107.5T812-560q0-66-25.5-126.5T714-794l48-48q57 57 87.5 129.5T880-560q0 80-30.5 152.5T762-278Z" />
              </svg>
              <h3>Tráfego de rede</h3>
            </span>
          </div>
        </a>

        <a href="./tela-servidores-codecs.html">
          <div class="btn-nav inativo" id="btn-nav-admin-servidores">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#8b979f">
                <path
                  d="M160-400v-80h640v80H160Zm0-120v-80h640v80H160ZM440-80v-128l-64 64-56-56 160-160 160 160-56 56-64-62v126h-80Zm40-560L320-800l56-56 64 64v-128h80v128l64-64 56 56-160 160Z" />
              </svg>
              <h3>Análise-Codecs</h3>
            </span>
          </div>
        </a>
      </div>

      <a href="./dashboard-jira.html">
        <div class="btn-nav inativo">
          <span>
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#8b979f">
              <path
                d="M160-160v-440h160v440H160Zm0-480v-160h160v160H160Zm240 480v-320h160v320H400Zm0-360v-160h160v160H400Zm240 360v-200h160v200H640Zm0-240v-160h160v160H640Z" />
            </svg>
            <h3>Chamados</h3>
          </span>
        </div>
      </a>

      <a href="./tela-administracao-usuario.html">
        <div class="btn-nav inativo" id="btn-nav-admin-usuarios">
          <span>
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#8b979f">
              <path
                d="M400-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM80-160v-112q0-33 17-62t47-44q51-26 115-44t141-18h14q6 0 12 2-8 18-13.5 37.5T404-360h-4q-71 0-127.5 18T180-306q-9 5-14.5 14t-5.5 20v32h252q6 21 16 41.5t22 38.5H80Zm560 40-12-60q-12-5-22.5-10.5T584-204l-58 18-40-68 46-40q-2-14-2-26t2-26l-46-40 40-68 58 18q11-8 21.5-13.5T628-460l12-60h80l12 60q12 5 22.5 11t21.5 15l58-20 40 70-46 40q2 12 2 25t-2 25l46 40-40 68-58-18q-11 8-21.5 13.5T732-180l-12 60h-80Zm40-120q33 0 56.5-23.5T760-320q0-33-23.5-56.5T680-400q-33 0-56.5 23.5T600-320q0 33 23.5 56.5T680-240ZM400-560q33 0 56.5-23.5T480-640q0-33-23.5-56.5T400-720q-33 0-56.5 23.5T320-640q0 33 23.5 56.5T400-560Zm0-80Zm12 400Z" />
            </svg>
            <h3>Adm - Usuários</h3>
          </span>
        </div>
      </a>

      <a href="./tela-administracao-servidores.html">
        <div class="btn-nav inativo" id="btn-nav-admin-servidores">
          <span>
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#8b979f">
              <path
                d="M200-200v-160 4-4 160Zm0 80q-33 0-56.5-23.5T120-200v-160q0-33 23.5-56.5T200-440h560q33 0 56.5 23.5T840-360H200v160h400v80H200Zm0-400q-33 0-56.5-23.5T120-600v-160q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v160q0 33-23.5 56.5T760-520H200Zm0-80h560v-160H200v160Zm0 0v-160 160ZM760-40v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80Z" />
            </svg>
            <h3>Adm - Servidores</h3>
          </span>
        </div>
      </a>

      <div class="btn-nav btn-logout inativo" onclick="limparSessao()">
        <a href="./index.html">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#8b979f">
            <path
              d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z" />
          </svg>
          <h3>Sair</h3>
        </a>
      </div>
    </div>

    <div class="dash">
        <div class="dash__conteudo">

            <div class="control-bar">
                <div class="input-wrapper">
                    <p class="control-label">Servidor <span id="statusBadge"></span></p>
                    <select id="selectServidor" class="select-input">
                        <option>Carregando...</option>
                    </select>
                </div>

                <div class="control-group">
                    <div class="input-wrapper">
                        <p class="control-label">Data Referência</p>
                        <input type="date" id="date1" class="date-input">
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="input-wrapper">
                        <p class="control-label">Data Atual</p>
                        <input type="date" id="date2" class="date-input">
                    </div>
                </div>

                <button class="btn-primary" id="btnConsultar">
                    <i class="fa-solid fa-magnifying-glass-chart"></i> Comparar
                </button>
            </div>

            <div id="msgErro" style="display:none; color:red; font-size:18px; margin-top:12px;">
                Nenhum dado encontrado.
            </div>

            <div class="summary-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">CPU (Média)</span>
                        <div class="kpi-icon"><i class="fa-solid fa-microchip"></i></div>
                    </div>
                    <div class="kpi-value" id="kpiCPU">--%</div>
                    <div class="kpi-subtext">Pico: <span id="picoCPU">--%</span></div>

                    <div class="kpi-delta" id="deltaCPU">
                        <span style="color: #999;">Aguardando...</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">RAM (Média)</span>
                        <div class="kpi-icon"><i class="fa-solid fa-memory"></i></div>
                    </div>
                    <div class="kpi-value" id="kpiRAM">--%</div>
                    <div class="kpi-subtext">Pico: <span id="picoRAM">--%</span></div>

                    <div class="kpi-delta" id="deltaRAM">
                        <span style="color: #999;">Aguardando...</span>
                    </div>
                </div>
            </div>

            <div class="alerts-grid">
                <div class="alert-card">
                    <div class="alert-header">
                        <h3>Alertas (Ref) <span id="labelDataRef" style="font-size:0.8em; color:#666;"></span></h3>
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <div class="alert-content" id="listaAlertasRef">
                        <p class="empty-msg">Aguardando dados...</p>
                    </div>
                </div>

                <div class="alert-card">
                    <div class="alert-header">
                        <h3>Alertas (Atual) <span id="labelDataAtual" style="font-size:0.8em; color:#666;"></span></h3>
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <div class="alert-content" id="listaAlertasAtual">
                        <p class="empty-msg">Aguardando dados...</p>
                    </div>
                </div>
            </div>

            <div class="charts-area">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3>Processamento (CPU)</h3>
                    </div>
                    <div class="graph-container"><canvas id="chartCPU"></canvas></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3>Memória (RAM)</h3>
                    </div>
                    <div class="graph-container"><canvas id="chartRAM"></canvas></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3>Armazenamento (Tendência)</h3>
                    </div>
                    <div class="graph-container"><canvas id="chartDisco"></canvas></div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">


const idEmpresa = sessionStorage.fkEmpresa; 
let limitesGlobais = {}; 
let chartCPU, chartRAM, chartDisco;
window.listaServidores = [];


document.addEventListener("DOMContentLoaded", async () => {
    inicializarGraficos();

    const hoje = new Date();
    const ontem = new Date();
    ontem.setDate(ontem.getDate() - 1);

    document.getElementById("date1").value = ontem.toISOString().split("T")[0];
    document.getElementById("date2").value = hoje.toISOString().split("T")[0];

    await carregarServidores();

    document.getElementById("btnConsultar")
        .addEventListener("click", atualizar);
});



async function carregarServidores() {
    const selectServidor = document.getElementById("selectServidor");

    try {
        const res = await fetch(`servidores/select/servidor/${idEmpresa}`);
        const lista = await res.json();

        window.listaServidores = lista;

        selectServidor.innerHTML = `<option value="">Selecione...</option>`;

        lista.forEach(item => {
            const opt = document.createElement("option");

            opt.value = item.id;         
            opt.textContent = item.nome;  
            selectServidor.appendChild(opt);
        });

    } catch (err) {
        console.error(err);
        selectServidor.innerHTML = `<option value="">Erro ao carregar</option>`;
    }
}

async function pegarDadosS3(ano, mes, dia, servidorNome) {
    const url = `/dados/${ano}/${mes}/${dia}/${servidorNome}`;

    try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) return [];

        const json = await res.json();
        return json || [];
        

    } catch { return []; }
}

 
async function atualizar() {
    const idServidor = document.getElementById("selectServidor").value;
    if (!idServidor) return alert("Selecione um servidor.");

    const servidorObj = window.listaServidores.find(s => s.id == idServidor);
    if (!servidorObj) return alert("Erro ao encontrar servidor.");

    const nomeServidor = servidorObj.nome; 

    const btn = document.getElementById("btnConsultar");
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Buscando...';

    resetarKPIs();
    limparAlertas();
    document.getElementById("statusBadge").innerHTML = "";

    const [a1, m1, d1] = document.getElementById("date1").value.split("-");
    const [a2, m2, d2] = document.getElementById("date2").value.split("-");

    document.getElementById("labelDataRef").innerText = `(${d1}/${m1}/${a1})`;
    document.getElementById("labelDataAtual").innerText = `(${d2}/${m2}/${a2})`;

    try {
        await carregarParametros(idServidor);

        const [rawRef, rawAtual] = await Promise.all([
            pegarDadosS3(a1, m1, d1, nomeServidor),
            pegarDadosS3(a2, m2, d2, nomeServidor)
        ]);

        console.log("RAW REF: ", rawRef);
        console.log("RAW ATUAL:", rawAtual);

        if (rawRef.length === 0 && rawAtual.length === 0) {
            btn.disabled = false;
            btn.innerHTML = originalText;
            return alert("Sem dados.");
        }

        const refAgrupado   = agruparPorJanela30min(rawRef);
        const atualAgrupado = agruparPorJanela30min(rawAtual);

        plotarGraficosOtimizados(refAgrupado, atualAgrupado);
        calcularKPIsComPico(refAgrupado, atualAgrupado);
        definirStatusGeral(atualAgrupado);

        gerarListaAlertas(refAgrupado, "listaAlertasRef");
        gerarListaAlertas(atualAgrupado, "listaAlertasAtual");

    } catch (erro) {
        console.error(erro);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}


function agruparPorJanela30min(dados) {
    if (!dados) return [];

    const mapa = {};

    for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {

            const key = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            
            mapa[key] = {
                cpu: [], ram: [], disco: [],
                status_cpu: [], status_ram: [], status_disco: []
            };
        }
    }

    dados.forEach(reg => {
        const dataFormatada = reg.timestamp.replace(" ", "T");
        const dt = new Date(dataFormatada);

        const minArredondado = dt.getMinutes() < 30 ? 0 : 30;
        dt.setMinutes(minArredondado, 0, 0);

        const chave = dt.toTimeString().substring(0, 5);

        if (mapa[chave]) {
            mapa[chave].cpu.push(+reg.cpu);
            mapa[chave].ram.push(+reg.ram);
            mapa[chave].disco.push(+reg.disco);

            if (reg.status_cpu) mapa[chave].status_cpu.push(reg.status_cpu);
            if (reg.status_ram) mapa[chave].status_ram.push(reg.status_ram);
            if (reg.status_disco) mapa[chave].status_disco.push(reg.status_disco);
        }
    });

    const resultado = [];

    Object.keys(mapa).sort().forEach(key => {
        const b = mapa[key];
        if (b.cpu.length > 0) {
            resultado.push({
                timestamp: key,

                cpu: media(b.cpu),
                ram: media(b.ram),
                disco: media(b.disco),

                cpuMax: Math.max(...b.cpu),
                ramMax: Math.max(...b.ram),
                discoMax: Math.max(...b.disco),

                status_cpu: b.status_cpu.includes("CRITICO") ? "CRITICO" :
                            b.status_cpu.includes("ALERTA")  ? "ALERTA" : "OK",

                status_ram: b.status_ram.includes("CRITICO") ? "CRITICO" :
                            b.status_ram.includes("ALERTA")  ? "ALERTA" : "OK",

                status_disco: b.status_disco.includes("CRITICO") ? "CRITICO" :
                              b.status_disco.includes("ALERTA")  ? "ALERTA" : "OK"
            });
        }
    });

    return resultado;
}



function media(arr) {
    return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
}



function calcularKPIsComPico(ref, atual) {
    atualizarKPI("kpiCPU", "picoCPU", "deltaCPU", ref, atual, "cpu", "cpuMax");
    atualizarKPI("kpiRAM", "picoRAM", "deltaRAM", ref, atual, "ram", "ramMax");
}

function atualizarKPI(idMed, idPico, idDelta, ref, atual, campoMed, campoMax) {
    const elMed = document.getElementById(idMed);
    const elPico = document.getElementById(idPico);
    const elDelta = document.getElementById(idDelta);

    const mAtual = media(atual.map(d => d[campoMed]));
    const mRef = media(ref.map(d => d[campoMed]));

    const picoAtual = atual.length ? Math.max(...atual.map(d => d[campoMax] || d[campoMed])) : 0;

    if (isNaN(mAtual) || atual.length === 0) {
        elMed.innerText = "--%";
        elPico.innerText = "--%";
        return;
    }

    elMed.innerText = mAtual.toFixed(1) + "%";
    elPico.innerText = picoAtual.toFixed(1) + "%";

    if (ref.length === 0) {
        elDelta.innerHTML = "Sem ref";
        return;
    }

    const diff = mAtual - mRef;
    let cor = diff > 0.1 ? "#e74c3c" : (diff < -0.1 ? "#2ecc71" : "#7f8c8d");
    let icon = diff > 0.1 ? "fa-arrow-trend-up" : (diff < -0.1 ? "fa-arrow-trend-down" : "fa-minus");
    let sinal = diff > 0.1 ? "+" : "";

    elDelta.innerHTML =
        `<span style="color:${cor}; font-weight:bold">
            <i class="fa-solid ${icon}"></i> ${sinal}${diff.toFixed(1)}% ref
        </span>`;
}


 
function definirStatusGeral(dados) {
    const badge = document.getElementById("statusBadge");
    if (!dados.length) return;

    const maxCPU = Math.max(...dados.map(d => d.cpuMax || d.cpu));
    const maxRAM = Math.max(...dados.map(d => d.ramMax || d.ram));

    const maior = Math.max(maxCPU, maxRAM);

    badge.className = "status-badge";
    if (maior >= 90) {
        badge.classList.add("status-critico");
        badge.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> CRÍTICO';
    } else if (maior >= 75) {
        badge.classList.add("status-alerta");
        badge.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> ALERTA';
    } else {
        badge.classList.add("status-ok");
        badge.innerHTML = '<i class="fa-solid fa-check-circle"></i> NORMAL';
    }
}

 
function inicializarGraficos() {
    chartCPU = criarChart("chartCPU");
    chartRAM = criarChart("chartRAM");
    chartDisco = criarChart("chartDisco");
}

function criarChart(id) {
    return new Chart(document.getElementById(id).getContext("2d"), {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null)
                                label += context.parsed.y.toFixed(1) + '%';

                            if (context.dataset.picoData) {
                                const pico = context.dataset.picoData[context.dataIndex];
                                if (pico)
                                    label += ` (Pico: ${pico.toFixed(1)}%)`;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, max: 100 }
            },
            elements: { point: { radius: 0 }, line: { tension: 0.3 } }
        }
    });
}

function plotarGraficosOtimizados(ref, atual) {
    const labels = Array.from(new Set([...ref.map(d => d.timestamp), ...atual.map(d => d.timestamp)])).sort();

    const mapData = (list, key) => labels.map(l => {
        const f = list.find(x => x.timestamp === l);
        return f ? f[key] : null;
    });

    updChart(chartCPU, labels,
        mapData(ref, 'cpu'), mapData(atual, 'cpu'),
        mapData(atual, 'cpuMax'), limitesGlobais["CPU"]
    );

    updChart(chartRAM, labels,
        mapData(ref, 'ram'), mapData(atual, 'ram'),
        mapData(atual, 'ramMax'), limitesGlobais["RAM"]
    );

    updChart(chartDisco, labels,
        mapData(ref, 'disco'), mapData(atual, 'disco'),
        mapData(atual, 'discoMax'), limitesGlobais["Disco"]
    );
}

function updChart(chart, lbls, dRef, dAtuAvg, dAtuMax, limites) {
    chart.data.labels = lbls;

    const paramAlerta  = limites ? limites.alerta  : null;
    const paramCritico = limites ? limites.critico : null;

    chart.data.datasets = [
        {
            label: 'Ref (Média)',
            data: dRef,
            borderColor: '#bdc3c7',
            borderDash: [5, 5],
            borderWidth: 2,
            pointRadius: 0
        },
        {
            label: 'Atual (Média)',
            data: dAtuAvg,
            picoData: dAtuMax,
            borderColor: '#2ecc71',
            backgroundColor: 'rgba(46,204,113,0.1)',
            borderWidth: 2,
            fill: true,

            pointBackgroundColor(context) {
                if (!limites) return 'transparent';
                const pico = context.dataset.picoData[context.dataIndex];
                if (pico >= paramCritico) return '#e74c3c';
                if (pico >= paramAlerta)  return '#f1c40f';
                return 'transparent';
            },

            pointRadius(context) {
                if (!limites) return 0;
                const pico = context.dataset.picoData[context.dataIndex];
                if (pico >= paramAlerta) return 5;
                return 0;
            },

            pointHoverRadius: 7
        }
    ];

    chart.update();
}


 
function gerarListaAlertas(lista, id) {
    const div = document.getElementById(id);
    div.innerHTML = "";

    const listaFiltrada = lista.filter(d =>
        d.status_cpu !== "OK" ||
        d.status_ram !== "OK" ||
        d.status_disco !== "OK"
    );

    if (!listaFiltrada.length) {
        div.innerHTML = '<p class="empty-msg">Nenhum alerta crítico encontrado.</p>';
        return;
    }

    let html = "";

    listaFiltrada.forEach(d => {
        if (d.status_cpu !== "OK")
            html += cardAlerta(d.timestamp, "CPU", d.cpuMax, d.status_cpu);

        if (d.status_ram !== "OK")
            html += cardAlerta(d.timestamp, "RAM", d.ramMax, d.status_ram);

        if (d.status_disco !== "OK")
            html += cardAlerta(d.timestamp, "Disco", d.discoMax || d.disco, d.status_disco);
    });

    div.innerHTML = html;
}

function cardAlerta(hora, tipo, valor, status) {
    let cor = "#777";
    let icon = "fa-circle-info";

    if (status === "CRITICO") {
        cor = "#e74c3c";
        icon = "fa-circle-xmark";
    } else if (status === "ALERTA") {
        cor = "#f1c40f";
        icon = "fa-triangle-exclamation";
    } else if (status === "OK") {
        cor = "#2ecc71";
        icon = "fa-check-circle";
    }

    return `
        <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
            <div>
                <span style="font-weight:bold;">${hora} - ${tipo}</span>
                <br>
                <span style="color:${cor}; font-weight:bold;"><i class="fa-solid ${icon}"></i> ${status}</span>
            </div>
            <div><strong>${valor.toFixed(1)}%</strong></div>
        </div>`;
}



function resetarKPIs() {
    ["CPU", "RAM"].forEach(t => {
        document.getElementById(`kpi${t}`).innerText = "--%";
        document.getElementById(`pico${t}`).innerText = "--%";
        document.getElementById(`delta${t}`).innerHTML = "Aguardando...";
    });
}

function limparAlertas() {
    document.getElementById("listaAlertasRef").innerHTML = "...";
    document.getElementById("listaAlertasAtual").innerHTML = "...";
}

 
async function carregarParametros(idServidor) {
    limitesGlobais = {};

    try {
        const resposta = await fetch(`servidores/buscarParametros/${idServidor}`);

        if (resposta.status === 204 || resposta.status === 404) {
            console.log("Nenhum parâmetro encontrado para este servidor.");
            return;
        }

        if (resposta.ok) {
            const dados = await resposta.json();

            if (!dados.length) return;

            dados.forEach(param => {
                limitesGlobais[param.componente.trim()] = {
                    alerta: Number(param.alerta),
                    critico: Number(param.em_risco_max)
                };
            });

            console.log("Parâmetros carregados:", limitesGlobais);
        }

    } catch (e) {
        console.error("Erro ao buscar parâmetros:", e);
    }
}

</script>

</body>

</html>