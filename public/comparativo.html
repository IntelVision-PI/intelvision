<!DOCTYPE html>

<html lang="pt-br">



<head>

    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>IntelVision | Comparativo de Performance</title>



    <link rel="stylesheet" href="css/global.css">

    <link rel="stylesheet" href="css/comparativo.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module" src="js/comparativo.js"></script>
    <script src="./js/sessao.js"></script>
    <script src="./js/alerta.js"></script>



</head>



<body onload="validarSessaoAdministrador()">



    <div class="header-left">

        <h1>IntelVision</h1>



        <div class="escolhaDash">



            <div class="btn-nav inativo">

                <a href="servidores.html">

                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">

                        <path
                            d="M520-600v-240h320v240H520ZM120-440v-400h320v400H120Zm400 320v-400h320v400H520Zm-400 0v-240h320v240H120Zm80-400h160v-240H200v240Zm400 320h160v-240H600v240Zm0-480h160v-80H600v80ZM200-200h160v-80H200v80Zm160-320Zm240-160Zm0 240ZM360-280Z" />

                    </svg>

                    <h3>Dashboard</h3>

                </a>

            </div>







            <div class="btn-nav inativo">

                <a href="./tela-administracao-usuario.html">

                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">

                        <path
                            d="M400-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM80-160v-112q0-33 17-62t47-44q51-26 115-44t141-18h14q6 0 12 2-8 18-13.5 37.5T404-360h-4q-71 0-127.5 18T180-306q-9 5-14.5 14t-5.5 20v32h252q6 21 16 41.5t22 38.5H80Zm560 40-12-60q-12-5-22.5-10.5T584-204l-58 18-40-68 46-40q-2-14-2-26t2-26l-46-40 40-68 58 18q11-8 21.5-13.5T628-460l12-60h80l12 60q12 5 22.5 11t21.5 15l58-20 40 70-46 40q2 12 2 25t-2 25l46 40-40 68-58-18q-11 8-21.5 13.5T732-180l-12 60h-80Zm40-120q33 0 56.5-23.5T760-320q0-33-23.5-56.5T680-400q-33 0-56.5 23.5T600-320q0 33 23.5 56.5T680-240ZM400-560q33 0 56.5-23.5T480-640q0-33-23.5-56.5T400-720q-33 0-56.5 23.5T320-640q0 33 23.5 56.5T400-560Zm0-80Zm12 400Z" />

                    </svg>

                    <h3>Adm - Usuários</h3>

                </a>

            </div>



            <div class="btn-nav inativo">

                <a href="./tela-administracao-servidores.html">

                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">

                        <path
                            d="M200-200v-160 4-4 160Zm0 80q-33 0-56.5-23.5T120-200v-160q0-33 23.5-56.5T200-440h560q33 0 56.5 23.5T840-360H200v160h400v80H200Zm0-400q-33 0-56.5-23.5T120-600v-160q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v160q0 33-23.5 56.5T760-520H200Zm0-80h560v-160H200v160Zm0 0v-160 160ZM760-40v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80Z" />

                    </svg>

                    <h3>Adm - Servidores</h3>

                </a>

            </div>

            <div class="btn-nav ativo">

                <a href="#">

                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">

                        <path
                            d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480v-80H240v80Zm0-160h480v-80H240v80Zm0-160h480v-80H240v80ZM200-200v-560 560Z" />

                    </svg>

                    <h3>Comparativo</h3>

                </a>

            </div>



        </div>



        <div class="btn-nav btn-logout inativo" onclick="limparSessao()">

            <a href="./index.html">

                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">

                    <path
                        d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z" />

                </svg>

                <h3>Sair</h3>

            </a>

        </div>

    </div>





    <div class="dash">

        <div class="dash__conteudo">



            <div class="control-bar">

                <div class="input-wrapper">

                    <p class="control-label">Servidor</p>

                    <select id="selectServidor" class="select-input">

                        <option>Carregando...</option>

                    </select>

                </div>





                <div class="control-group">



                    <div class="input-wrapper">



                        <p class="control-label">Data Referência (Passado)</p>



                        <input type="date" id="date1" class="date-input">



                    </div>



                    <div class="vs-badge">VS</div>



                    <div class="input-wrapper">



                        <p class="control-label">Data Análise (Atual)</p>



                        <input type="date" id="date2" class="date-input">



                    </div>



                    <div class="quick-actions">





                        <button onclick="setLast24h()">Últimas 24h</button>



                        <button onclick="setLastWeek()">Semana</button>



                    </div>



                </div>







                <button class="btn-primary" id="btnConsultar">
                    <i class="fa-solid fa-magnifying-glass-chart"></i> Comparar Performance
                </button>



            </div>

            <div id="msgErro" style="display:none; color:red; font-size:18px; margin-top:12px;">

                Nenhum dado encontrado para esse servidor/data.

            </div>

            <div class="summary-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">CPU (Média)</span>
                        <div class="kpi-icon"><i class="fa-solid fa-microchip"></i></div>
                    </div>
                    <div class="kpi-value" id="kpiCPU">--%</div>
                    <div class="kpi-delta" id="deltaCPU">
                        <span style="color: #999; font-weight: 400;">Aguardando...</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">RAM (Média)</span>
                        <div class="kpi-icon"><i class="fa-solid fa-memory"></i></div>
                    </div>
                    <div class="kpi-value" id="kpiRAM">--%</div>
                    <div class="kpi-delta" id="deltaRAM">
                        <span style="color: #999; font-weight: 400;">Aguardando...</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Disco (Média)</span>
                        <div class="kpi-icon"><i class="fa-solid fa-hard-drive"></i></div>
                    </div>
                    <div class="kpi-value" id="kpiDisco">--%</div>
                    <div class="kpi-delta" id="deltaDisco">
                        <span style="color: #999; font-weight: 400;">Aguardando...</span>
                    </div>
                </div>
            </div>


            <div class="charts-area">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3>Comparativo de Processamento (CPU)</h3>
                    </div>
                    <div class="graph-container">
                        <canvas id="chartCPU"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3>Comparativo de Memória (RAM)</h3>
                    </div>
                    <div class="graph-container">
                        <canvas id="chartRAM"></canvas>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3>Comparativo de Armazenamento</h3>
                    </div>
                    <div class="graph-container">
                        <canvas id="chartDisco"></canvas>
                    </div>
                </div>
            </div>

        </div>

    </div>



   <script type="module">
        import { pegarDadosS3, inicializarGraficos, atualizarGraficos } from "./js/comparativo.js";

        document.addEventListener("DOMContentLoaded", async () => {
            inicializarGraficos();

            const hoje = new Date().toISOString().split("T")[0];
            document.getElementById("date1").value = hoje;
            document.getElementById("date2").value = hoje;

            // Carregar Select de Servidores
            const select = document.getElementById("selectServidor");
            try {
                const res = await fetch("/dados/select"); // Ajuste sua rota se necessario
                const servidores = await res.json();
                select.innerHTML = `<option value="">Selecione...</option>`;
                servidores.forEach(s => {
                    const opt = document.createElement("option");
                    opt.value = s.nome || s.hostname || s.id;
                    opt.textContent = s.nome || s.hostname || s.id;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error(err);
                select.innerHTML = `<option>Erro ao carregar</option>`;
            }

            const btn = document.getElementById("btnConsultar");
            if (btn) btn.addEventListener("click", atualizar);

            async function atualizar() {
                const servidor = select.value;
                if (!servidor || servidor === "Carregando..." || servidor === "") {
                    alert("Por favor, selecione um servidor primeiro.");
                    return;
                }

                const textoOriginal = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Buscando...';
                btn.disabled = true;

                const [ano1, mes1, dia1] = document.getElementById("date1").value.split("-");
                const [ano2, mes2, dia2] = document.getElementById("date2").value.split("-");

                try {
                    // Pega os dados brutos (arrays de registros)
                    const dadosRef = await pegarDadosS3(ano1, mes1, dia1, servidor);
                    const dadosAtual = await pegarDadosS3(ano2, mes2, dia2, servidor);

                    if (dadosRef.vazio || dadosAtual.vazio) {
                        document.getElementById("msgErro").style.display = "block";
                        atualizarGraficos({ vazio: true }, { vazio: true });
                        resetarKPIs(); // Limpa as KPIs se não tiver dados
                    } else {
                        document.getElementById("msgErro").style.display = "none";
                        atualizarGraficos(dadosRef, dadosAtual);
                        
                        // AQUI ESTÁ A MÁGICA DOS KPIS
                        calcularEExibirKPIs(dadosRef, dadosAtual);
                    }
                } catch (error) {
                    console.error("Erro ao atualizar:", error);
                } finally {
                    btn.innerHTML = textoOriginal;
                    btn.disabled = false;
                }
            }

            // --- FUNÇÕES DE KPI ---

            function calcularEExibirKPIs(ref, atual) {
                // Supondo que seus dados venham com chaves: cpu, ram, disco (ou similar)
                // Se as chaves do JSON forem diferentes (ex: processamento), ajuste abaixo.
                
                atualizarCardKPI("kpiCPU", "deltaCPU", ref, atual, "cpu");
                atualizarCardKPI("kpiRAM", "deltaRAM", ref, atual, "ram");
                atualizarCardKPI("kpiDisco", "deltaDisco", ref, atual, "disco");
            }

            function atualizarCardKPI(idValor, idDelta, dadosRef, dadosAtual, metrica) {
                // 1. Calcular médias
                const mediaRef = calcularMediaArray(dadosRef, metrica);
                const mediaAtual = calcularMediaArray(dadosAtual, metrica);

                // 2. Calcular diferença (Pontos percentuais)
                const diferenca = mediaAtual - mediaRef;

                // 3. Atualizar Valor Principal
                document.getElementById(idValor).innerText = mediaAtual.toFixed(1) + "%";

                // 4. Configurar Delta (Diferença)
                const divDelta = document.getElementById(idDelta);
                
                let icone = "";
                let cor = "";
                let sinal = diferenca > 0 ? "+" : ""; // Adiciona o + se for positivo

                // Lógica: Aumento de consumo (positivo) = Ruim (Vermelho)
                // Queda de consumo (negativo) = Bom (Verde)
                if (diferenca > 0.1) {
                    icone = '<i class="fa-solid fa-arrow-trend-up"></i>';
                    cor = "red"; // Vermelho pq aumentou consumo
                } else if (diferenca < -0.1) {
                    icone = '<i class="fa-solid fa-arrow-trend-down"></i>';
                    cor = "green"; // Verde pq economizou recurso
                } else {
                    icone = '<i class="fa-solid fa-minus"></i>';
                    cor = "gray"; // Neutro
                }

                divDelta.innerHTML = `
                    <span style="color: ${cor}; font-weight: bold; display: flex; align-items: center; gap: 5px;">
                        ${icone} ${sinal}${diferenca.toFixed(1)}%
                    </span>
                    <span style="color: #999; font-size: 12px; margin-left: 5px;">vs ref.</span>
                `;
            }

            function calcularMediaArray(dados, chave) {
                // Se o dado não for um array (ex: objeto único), adapta-se
                const lista = Array.isArray(dados) ? dados : (dados.dados || []);
                
                if (lista.length === 0) return 0;

                const soma = lista.reduce((acc, item) => {
                    // Garante que é número. Ajuste 'item[chave]' se o nome da coluna for diferente
                    return acc + (parseFloat(item[chave]) || 0);
                }, 0);

                return soma / lista.length;
            }

            function resetarKPIs() {
                ["kpiCPU", "kpiRAM", "kpiDisco"].forEach(id => document.getElementById(id).innerText = "--%");
                ["deltaCPU", "deltaRAM", "deltaDisco"].forEach(id => document.getElementById(id).innerHTML = "<span>--</span>");
            }
        });
    </script>

</body>

</html>